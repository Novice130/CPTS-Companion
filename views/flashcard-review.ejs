<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Flashcard Review | CPTS Companion</title>
  <link rel="icon" type="image/jpeg" href="<%= basePath %>/favicon.jpg">
  <link rel="stylesheet" href="<%= basePath %>/css/style.css">
</head>
<body class="scanlines">
  <%- include('partials/sidebar', { currentPage: 'flashcards', stats, dueCount }) %>
  
  <div class="main-wrapper">
    <%- include('partials/topbar', { stats, nextReview }) %>
    
    <main class="main-content">
      <div class="breadcrumbs">
        <a href="<%= basePath %>/">Dashboard</a>
        <span>‚Ä∫</span>
        <a href="<%= basePath %>/flashcards">Flashcards</a>
        <span>‚Ä∫</span>
        <span>Review</span>
      </div>
      
      <h1>üÉè Flashcard Review</h1>
      <p class="text-muted mb-3">Cards remaining: <span id="remaining"><%= flashcards.length %></span></p>
      
      <% if (flashcards.length > 0) { %>
        <div id="flashcardContainer">
          <div class="flashcard" id="currentCard" onclick="flipCard()">
            <div class="flashcard-inner">
              <div class="flashcard-question" id="question"></div>
              <div class="flashcard-answer" id="answer"></div>
            </div>
          </div>
          
          <div id="ratingButtons" style="display: none; margin-top: 1.5rem;">
            <p class="text-muted mb-2" style="text-align: center;">How well did you know this?</p>
            <div class="flashcard-controls" style="max-width: 600px; margin: 0 auto;">
              <button class="btn btn-danger" onclick="rateCard(1)">Again<br><small>1 day</small></button>
              <button class="btn" onclick="rateCard(2)">Hard<br><small>Shorter</small></button>
              <button class="btn" onclick="rateCard(3)">Good<br><small>Normal</small></button>
              <button class="btn btn-primary" onclick="rateCard(4)">Easy<br><small>Longer</small></button>
            </div>
          </div>
          
          <div style="text-align: center; margin-top: 1rem;">
            <button class="btn" onclick="flipCard()">Flip Card (Space)</button>
          </div>
        </div>
        
        <div id="completedMessage" style="display: none;" class="empty-state">
          <div class="empty-state-icon">üéâ</div>
          <div class="empty-state-title">All done!</div>
          <p>You've reviewed all due flashcards. Great work!</p>
          <a href="<%= basePath %>/flashcards" class="btn btn-primary">Back to Flashcards</a>
        </div>
      <% } else { %>
        <div class="empty-state">
          <div class="empty-state-icon">‚úÖ</div>
          <div class="empty-state-title">No cards due!</div>
          <p>Come back later for more reviews.</p>
          <a href="<%= basePath %>/flashcards" class="btn btn-primary">Back to Flashcards</a>
        </div>
      <% } %>
    </main>
  </div>
  
  <%- include('partials/command-palette') %>
  <script src="<%= basePath %>/js/app.js"></script>
  <script>
    const cards = <%- JSON.stringify(flashcards) %>;
    let currentIndex = 0;
    let isFlipped = false;
    
    function showCard() {
      if (currentIndex >= cards.length) {
        document.getElementById('flashcardContainer').style.display = 'none';
        document.getElementById('completedMessage').style.display = 'block';
        return;
      }
      
      const card = cards[currentIndex];
      document.getElementById('question').textContent = card.question;
      document.getElementById('answer').textContent = card.answer;
      document.getElementById('remaining').textContent = cards.length - currentIndex;
      document.getElementById('currentCard').classList.remove('flipped');
      document.getElementById('ratingButtons').style.display = 'none';
      isFlipped = false;
    }
    
    function flipCard() {
      const cardEl = document.getElementById('currentCard');
      cardEl.classList.toggle('flipped');
      isFlipped = !isFlipped;
      
      if (isFlipped) {
        document.getElementById('ratingButtons').style.display = 'block';
      }
    }
    
    async function rateCard(quality) {
      const card = cards[currentIndex];
      
      try {
        await fetch('<%= basePath %>/api/flashcards/' + card.id + '/review', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ quality })
        });
      } catch (err) {
        console.error('Failed to submit review:', err);
      }
      
      currentIndex++;
      showCard();
    }
    
    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.code === 'Space') {
        e.preventDefault();
        flipCard();
      } else if (isFlipped) {
        if (e.key === '1') rateCard(1);
        else if (e.key === '2') rateCard(2);
        else if (e.key === '3') rateCard(3);
        else if (e.key === '4') rateCard(4);
      }
    });
    
    // Initialize
    showCard();
  </script>
</body>
</html>
