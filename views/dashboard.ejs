<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard | CPTS Companion</title>
  <link rel="icon" type="image/jpeg" href="/favicon.jpg">
  <link rel="stylesheet" href="/css/style.css">
</head>
<body class="scanlines">
  <%- include('partials/sidebar', { currentPage: 'dashboard', stats, dueCount }) %>
  
  <div class="main-wrapper">
    <%- include('partials/topbar', { stats, nextReview }) %>
    
    <main class="main-content">
      <h1>ğŸ‘‹ Welcome to CPTS Companion</h1>
      <p class="text-muted mb-3">Your <%= settings.plan_duration %>-day journey to HTB CPTS certification.</p>

      <!-- Stats Grid -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-card-icon">ğŸ“…</div>
          <div class="stat-card-content">
            <div class="stat-card-value">Day <%= currentDay %>/<%= settings.plan_duration %></div>
            <div class="stat-card-label">Current Day</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-card-icon">âœ…</div>
          <div class="stat-card-content">
            <div class="stat-card-value"><%= dayProgress.completed %>/<%= dayProgress.total %></div>
            <div class="stat-card-label">Today's Tasks</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-card-icon">ğŸ¯</div>
          <div class="stat-card-content">
            <div class="stat-card-value"><%= stats.completedExercises %>/<%= stats.totalExercises %></div>
            <div class="stat-card-label">Exercises Done</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-card-icon">ğŸƒ</div>
          <div class="stat-card-content">
            <div class="stat-card-value"><%= stats.dueFlashcards %></div>
            <div class="stat-card-label">Cards Due</div>
          </div>
        </div>
      </div>

      <!-- Today's Activities -->
      <div class="panel" style="margin-top: 1.5rem;">
        <div class="panel-header">
          <h3 class="panel-title"><span class="panel-title-icon">ğŸ“‹</span> Day <%= currentDay %> Activities</h3>
          <div style="display: flex; align-items: center; gap: 1rem;">
            <span class="text-muted"><%= dayProgress.percentage %>% complete</span>
            <% if (dayProgress.percentage === 100 && currentDay < settings.plan_duration) { %>
              <button class="btn btn-primary btn-sm" onclick="advanceToNextDay()">
                ğŸ‰ Start Day <%= currentDay + 1 %> â†’
              </button>
            <% } %>
          </div>
        </div>
        <div class="panel-body">
          <!-- Day Progress Bar -->
          <div class="progress-bar" style="height: 12px; margin-bottom: 1.5rem;">
            <div class="progress-fill" style="width: <%= dayProgress.percentage %>%;"></div>
          </div>
          
          <% if (todayActivities.length > 0) { %>
            <div class="activity-list">
              <% todayActivities.forEach(activity => { %>
                <div class="activity-item <%= activity.completed ? 'completed' : '' %>" data-activity-id="<%= activity.id %>">
                  <label class="activity-checkbox">
                    <input type="checkbox" 
                           <%= activity.completed ? 'checked' : '' %> 
                           onchange="toggleActivity(<%= activity.id %>, this.checked)">
                    <span class="checkmark"></span>
                  </label>
                  <div class="activity-content">
                    <div class="activity-title"><%= activity.title %></div>
                    <div class="activity-desc"><%= activity.description %></div>
                  </div>
                  <% if (activity.activity_type === 'module' && activity.activity_id) { %>
                    <a href="/modules/<%= activity.activity_id %>" class="btn btn-sm">View</a>
                  <% } else if (activity.activity_type === 'exercise' && activity.activity_id) { %>
                    <a href="/exercises/<%= activity.activity_id %>" class="btn btn-sm">Start</a>
                  <% } else if (activity.activity_type === 'flashcards') { %>
                    <a href="/flashcards/review" class="btn btn-sm">Review</a>
                  <% } else if (activity.activity_type === 'reflection') { %>
                    <button class="btn btn-sm" onclick="showReflection()">Write</button>
                  <% } %>
                </div>
              <% }) %>
            </div>
          <% } else { %>
            <div class="empty-state">
              <div class="empty-state-icon">ğŸ“‹</div>
              <div class="empty-state-title">No activities yet</div>
              <p>Activities will be generated when you start your study plan.</p>
            </div>
          <% } %>
        </div>
      </div>

      <!-- Reflection Section -->
      <div class="panel" style="margin-top: 1.5rem;" id="reflectionPanel">
        <div class="panel-header">
          <h3 class="panel-title"><span class="panel-title-icon">ğŸ“</span> Day <%= currentDay %> Reflection</h3>
          <span class="text-muted" id="reflectionStatus">Auto-saved</span>
        </div>
        <div class="panel-body">
          <textarea 
            class="reflection-textarea" 
            id="reflectionInput"
            placeholder="Write your thoughts, what you learned, challenges faced, and key takeaways for today..."
            onblur="saveReflection()"
          ><%= reflection ? reflection.content : '' %></textarea>
          <p class="text-muted" style="margin-top: 0.5rem; font-size: 0.85rem;">
            ğŸ’¡ Tip: Reflect on what you learned, what was challenging, and what you want to review tomorrow.
          </p>
        </div>
      </div>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-top: 1.5rem;">
        <!-- Quick Actions -->
        <div class="panel">
          <div class="panel-header">
            <h3 class="panel-title"><span class="panel-title-icon">âš¡</span> Quick Actions</h3>
          </div>
          <div class="panel-body">
            <div style="display: flex; flex-direction: column; gap: 0.75rem;">
              <a href="/exercises" class="btn" style="justify-content: flex-start;">
                ğŸ¯ Practice Exercises
              </a>
              <% if (stats.dueFlashcards > 0) { %>
                <a href="/flashcards/review" class="btn btn-primary" style="justify-content: flex-start;">
                  ğŸƒ Review <%= stats.dueFlashcards %> Due Flashcards
                </a>
              <% } %>
              <a href="/modules" class="btn" style="justify-content: flex-start;">
                ğŸ“š Browse Modules
              </a>
              <a href="/mindmaps" class="btn" style="justify-content: flex-start;">
                ğŸ—ºï¸ Explore Mind Maps
              </a>
            </div>
          </div>
        </div>

        <!-- Plan Overview -->
        <div class="panel">
          <div class="panel-header">
            <h3 class="panel-title"><span class="panel-title-icon">ğŸ“…</span> Plan Overview</h3>
            <a href="/settings" class="btn btn-sm">Change Plan</a>
          </div>
          <div class="panel-body">
            <div class="plan-overview">
              <div class="plan-stat">
                <strong><%= settings.plan_duration %> Days</strong>
                <span>Total Duration</span>
              </div>
              <div class="plan-stat">
                <strong><%= currentDay - 1 %></strong>
                <span>Days Completed</span>
              </div>
              <div class="plan-stat">
                <strong><%= settings.plan_duration - currentDay + 1 %></strong>
                <span>Days Remaining</span>
              </div>
            </div>
            <div class="progress-bar" style="height: 8px; margin-top: 1rem;">
              <div class="progress-fill" style="width: <%= Math.round(((currentDay - 1) / settings.plan_duration) * 100) %>%;"></div>
            </div>
            <p class="text-muted" style="margin-top: 0.5rem; font-size: 0.85rem;">
              <%= Math.round(((currentDay - 1) / settings.plan_duration) * 100) %>% of plan completed
            </p>
          </div>
        </div>
      </div>

      <!-- Recent Notes -->
      <div class="panel" style="margin-top: 1.5rem;">
        <div class="panel-header">
          <h3 class="panel-title"><span class="panel-title-icon">ğŸ“</span> Recent Notes</h3>
          <a href="/notes" class="btn btn-sm">View All</a>
        </div>
        <div class="panel-body">
          <% if (recentNotes.length > 0) { %>
            <div style="display: flex; flex-direction: column; gap: 0.75rem;">
              <% recentNotes.forEach(note => { %>
                <a href="/notes/<%= note.id %>" class="note-card" style="text-decoration: none;">
                  <div class="note-card-title"><%= note.title %></div>
                  <div class="note-card-meta">
                    <span><%= note.module_title || 'General' %></span>
                    <span><%= new Date(note.updated_at).toLocaleDateString() %></span>
                  </div>
                </a>
              <% }) %>
            </div>
          <% } else { %>
            <div class="empty-state">
              <div class="empty-state-icon">ğŸ“</div>
              <div class="empty-state-title">No notes yet</div>
              <p>Start taking notes during your studies!</p>
              <a href="/notes/new" class="btn btn-primary">Create Note</a>
            </div>
          <% } %>
        </div>
      </div>
    </main>
  </div>
  
  <%- include('partials/command-palette') %>
  <script src="/js/app.js"></script>
  <script>
    // Toggle activity completion
    async function toggleActivity(activityId, completed) {
      try {
        const res = await fetch(`/api/activities/${activityId}/toggle`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ completed })
        });
        const data = await res.json();
        
        if (data.success) {
          // Update UI
          const item = document.querySelector(`[data-activity-id="${activityId}"]`);
          if (completed) {
            item.classList.add('completed');
          } else {
            item.classList.remove('completed');
          }
          
          // Refresh page to update progress
          if (data.dayComplete) {
            showToast('ğŸ‰ Day complete! You can now proceed to the next day.');
          }
          setTimeout(() => location.reload(), 500);
        }
      } catch (err) {
        console.error('Error toggling activity:', err);
      }
    }
    
    // Advance to next day
    async function advanceToNextDay() {
      try {
        const res = await fetch('/api/plan/advance-day', {
          method: 'POST'
        });
        const data = await res.json();
        
        if (data.success) {
          showToast(`ğŸš€ Welcome to Day ${data.newDay}!`);
          setTimeout(() => location.reload(), 1000);
        }
      } catch (err) {
        console.error('Error advancing day:', err);
      }
    }
    
    // Save reflection
    let reflectionTimeout;
    async function saveReflection() {
      const content = document.getElementById('reflectionInput').value;
      const status = document.getElementById('reflectionStatus');
      
      status.textContent = 'Saving...';
      
      try {
        const res = await fetch('/api/reflections/<%= currentDay %>', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ content })
        });
        const data = await res.json();
        
        if (data.success) {
          status.textContent = 'Saved âœ“';
          setTimeout(() => { status.textContent = 'Auto-saved'; }, 2000);
        }
      } catch (err) {
        status.textContent = 'Error saving';
        console.error('Error saving reflection:', err);
      }
    }
    
    // Auto-save reflection on input
    document.getElementById('reflectionInput').addEventListener('input', () => {
      clearTimeout(reflectionTimeout);
      document.getElementById('reflectionStatus').textContent = 'Typing...';
      reflectionTimeout = setTimeout(saveReflection, 2000);
    });
    
    // Show reflection panel
    function showReflection() {
      document.getElementById('reflectionPanel').scrollIntoView({ behavior: 'smooth' });
      document.getElementById('reflectionInput').focus();
    }
  </script>
</body>
</html>
